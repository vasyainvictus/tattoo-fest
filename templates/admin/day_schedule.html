{% extends 'base.html' %}

{% block title %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ–º: {{ day.date.strftime('%d.%m.%Y') }}{% endblock %}

{% block content %}
<div style="max-width: 1200px; margin: 30px auto; padding: 20px;">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ–º: {{ day.date.strftime('%d %B %Y') }}</h1>
        <a href="{{ url_for('admin.manage_festival_details', festival_id=day.festival_id) }}" class="btn btn-outline-secondary btn-hover">–ù–∞–∑–∞–¥ –∫ –¥–Ω—è–º</a>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert {% if category == 'error' %}alert-danger{% elif category == 'info' %}alert-info{% else %}alert-success{% endif %}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <h4>–¢–µ–∫—É—â–µ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ</h4>
    {% if grouped_slots %}
    <table class="table table-bordered" style="font-size: 0.95em;">
        <thead class="table-light">
            <tr>
                <th style="width: 12%;">–í—Ä–µ–º—è</th>
                <th style="width: 30%;">–°–æ–±—ã—Ç–∏–µ/–ö–æ–Ω–∫—É—Ä—Å</th>
                <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è/–î–µ—Ç–∞–ª–∏</th>
                <th class="text-center">–ó–∞—è–≤–æ–∫</th>
                <th class="text-center">–°—É–¥–µ–π</th>
                <th class="text-center" style="width: 20%;">–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
        </thead>
        <tbody>
            {% for time, slots_in_time in grouped_slots %}
                {% for slot in slots_in_time %}
                <tr>
                    {% if loop.first %}
                        <td rowspan="{{ slots_in_time|length }}"><strong>{{ time }}</strong></td>
                    {% endif %}
                    <td>
                        {% if slot.type == 'judging' %}
                            <strong>{{ slot.nomination_template.name }}</strong><br>
                            <span class="text-muted small">–ó–æ–Ω–∞: {{ slot.zone or '–ù–µ —É–∫–∞–∑–∞–Ω–∞' }}</span>
                        {% elif slot.type == 'award' %}
                            <!-- ‚ñº‚ñº‚ñº –ò–ó–ú–ï–ù–ï–ù–ò–ï –í –¢–ê–ë–õ–ò–¶–ï ‚ñº‚ñº‚ñº -->
                            <strong>–ù–∞–≥—Ä–∞–∂–¥–µ–Ω–∏–µ</strong><br>
                            <span class="text-muted small">–ó–æ–Ω–∞: {{ slot.zone or '–ù–µ —É–∫–∞–∑–∞–Ω–∞' }}</span>
                        {% else %}
                            <strong>–°–æ–±—ã—Ç–∏–µ</strong>
                        {% endif %}
                    </td>
                    <td>
                        {% if slot.type == 'judging' %}
                            {{ CATEGORY_MAP.get(slot.category, slot.category) }}
                        {% elif slot.type == 'award' %}
                            <!-- ‚ñº‚ñº‚ñº –ò–ó–ú–ï–ù–ï–ù–ò–ï –í –¢–ê–ë–õ–ò–¶–ï ‚ñº‚ñº‚ñº -->
                            {% if slot.category %}
                                {{ CATEGORY_MAP.get(slot.category, '–ö–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–µ —É–∫–∞–∑–∞–Ω–∞') }}
                            {% else %}
                                <span class="text-muted">–ö–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–µ —É–∫–∞–∑–∞–Ω–∞</span>
                            {% endif %}
                        {% else %}
                            {{ slot.event_title }}
                        {% endif %}
                    </td>
                    <td class="text-center">{{ slot.participants|length if slot.type == 'judging' else '-' }}</td>
                    <td class="text-center">{{ slot.judge_assignments|length if slot.type == 'judging' else '-' }}</td>
                    <td class="text-center">
                        <div class="d-flex justify-content-center gap-2 flex-wrap">
                            {% if slot.type == 'judging' %}
                                <a href="{{ url_for('admin.manage_slot_participants', slot_id=slot.id) }}" class="btn btn-info btn-sm text-white">–£—á–∞—Å—Ç–Ω–∏–∫–∏</a>
                                <a href="{{ url_for('admin.manage_slot_judges', slot_id=slot.id) }}" class="btn btn-primary btn-sm">–°—É–¥—å–∏</a>
                            {% endif %}
                            <a href="{{ url_for('admin.edit_slot', slot_id=slot.id) }}" class="btn btn-warning btn-sm text-dark">‚öôÔ∏è</a>
                            <form action="{{ url_for('admin.delete_slot', slot_id=slot.id) }}" method="post" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Å–ª–æ—Ç?');">
                                <button type="submit" class="btn btn-danger btn-sm">üóëÔ∏è</button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            {% endfor %}
        </tbody>
    </table>
    {% else %}
        <p class="text-center text-muted mb-4">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è —ç—Ç–æ–≥–æ –¥–Ω—è –µ—â–µ –Ω–µ —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–æ.</p>
    {% endif %}

    <div class="bg-light p-4 rounded">
        <h4>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Å–ª–æ—Ç –≤ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ</h4>
        <form method="post" id="addSlotForm">
            <div class="row mb-3 g-3">
                <div class="col-md-2">
                    <label for="start_time" class="form-label">–ù–∞—á–∞–ª–æ</label>
                    <input type="time" name="start_time" required class="form-control">
                </div>
                <div class="col-md-2">
                    <label for="end_time" class="form-label">–ö–æ–Ω–µ—Ü</label>
                    <input type="time" name="end_time" required class="form-control">
                </div>
                <div class="col-md-3">
                    <label for="slot_type" class="form-label">–¢–∏–ø —Å–ª–æ—Ç–∞</label>
                    <select id="slot_type" name="type" required class="form-select">
                        <option value="judging" selected>–°—É–¥–µ–π—Å—Ç–≤–æ (–ö–æ–Ω–∫—É—Ä—Å)</option>
                        <option value="award">–ù–∞–≥—Ä–∞–∂–¥–µ–Ω–∏–µ</option>
                        <option value="event">–°–æ–±—ã—Ç–∏–µ</option>
                    </select>
                </div>
            </div>

            <!-- ‚ñº‚ñº‚ñº –ë–õ–û–ö –°–£–î–ï–ô–°–¢–í–ê (–ò–ó–ú–ï–ù–ï–ù–´ –ò–ú–ï–ù–ê –ü–û–õ–ï–ô)‚ñº‚ñº‚ñº -->
            <div id="judging-fields" class="mb-3">
                <div class="row g-3">
                    <div class="col-md-5">
                        <label for="judging_nomination_template_id" class="form-label">–®–∞–±–ª–æ–Ω –Ω–æ–º–∏–Ω–∞—Ü–∏–∏</label>
                        <select name="nomination_template_id" id="judging_nomination_template_id" class="form-select">
                            <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —à–∞–±–ª–æ–Ω --</option>
                            {% for template in nomination_templates %}
                                <option value="{{ template.id }}">{{ template.name }} ({{ CATEGORY_MAP.get(template.participant_type, template.participant_type)}})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="judging_category" class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è —Ä–∞–±–æ—Ç—ã</label>
                        <select name="category" id="judging_category" class="form-select">
                            <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é --</option>
                            <option value="fresh">–ë–∏—Ç–≤–∞</option>
                            <option value="healed">–ó–∞–∂–∏–≤—à–∞—è</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="judging_zone" class="form-label">–ó–æ–Ω–∞</label>
                        <select name="zone" id="judging_zone" class="form-select">
                            <option value="">-- –ó–æ–Ω–∞ --</option>
                            {% for z in ZONES %}
                                <option value="{{ z }}">{{ z }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>

            <!-- ‚ñº‚ñº‚ñº –ë–õ–û–ö –ù–ê–ì–†–ê–ñ–î–ï–ù–ò–Ø (–ü–û–õ–ù–û–°–¢–¨–Æ –ü–ï–†–ï–†–ê–ë–û–¢–ê–ù) ‚ñº‚ñº‚ñº -->
            <div id="award-fields" class="mb-3" style="display: none;">
                 <div class="row g-3">
                    <div class="col-md-3">
                        <label for="award_category" class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏—è</label>
                        <select name="category" id="award_category" class="form-select">
                            <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é --</option>
                            <option value="fresh">–ë–∏—Ç–≤–∞</option>
                            <option value="healed">–ó–∞–∂–∏–≤—à–∞—è</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="award_zone" class="form-label">–ó–æ–Ω–∞</label>
                        <select name="zone" id="award_zone" class="form-select">
                            <option value="">-- –ó–æ–Ω–∞ --</option>
                            {% for z in ZONES %}
                                <option value="{{ z }}">{{ z }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>

            <!-- ‚ñº‚ñº‚ñº –ë–õ–û–ö –°–û–ë–´–¢–ò–Ø (–ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô) ‚ñº‚ñº‚ñº -->
            <div id="event-fields" style="display: none;">
                <label for="event_title" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è</label>
                <input type="text" name="event_title" class="form-control">
            </div>

            <button type="submit" class="btn btn-primary mt-3">–î–æ–±–∞–≤–∏—Ç—å —Å–ª–æ—Ç</button>
        </form>
    </div>
</div>

<!-- ‚ñº‚ñº‚ñº JAVASCRIPT (–ü–û–õ–ù–û–°–¢–¨–Æ –ü–ï–†–ï–ü–ò–°–ê–ù) ‚ñº‚ñº‚ñº -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const typeSelect = document.getElementById('slot_type');
        const judgingFields = document.getElementById('judging-fields');
        const awardFields = document.getElementById('award-fields');
        const eventFields = document.getElementById('event-fields');

        // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –∏–Ω–ø—É—Ç—ã –∏ —Å–µ–ª–µ–∫—Ç—ã –≤ –∫–∞–∂–¥–æ–º –±–ª–æ–∫–µ
        const judgingInputs = judgingFields.querySelectorAll('input, select');
        const awardInputs = awardFields.querySelectorAll('input, select');
        const eventInputs = eventFields.querySelectorAll('input, select');

        function toggleFields() {
            const selectedType = typeSelect.value;

            // –°–Ω–∞—á–∞–ª–∞ —Å–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –∏ –¥–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤—Å–µ –∏–Ω–ø—É—Ç—ã
            judgingFields.style.display = 'none';
            judgingInputs.forEach(input => input.disabled = true);
            
            awardFields.style.display = 'none';
            awardInputs.forEach(input => input.disabled = true);

            eventFields.style.display = 'none';
            eventInputs.forEach(input => input.disabled = true);

            // –ó–∞—Ç–µ–º –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—ã–π –±–ª–æ–∫ –∏ –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –µ–≥–æ –∏–Ω–ø—É—Ç—ã
            if (selectedType === 'judging') {
                judgingFields.style.display = 'block';
                judgingInputs.forEach(input => input.disabled = false);
            } else if (selectedType === 'award') {
                awardFields.style.display = 'block';
                awardInputs.forEach(input => input.disabled = false);
            } else if (selectedType === 'event') {
                eventFields.style.display = 'block';
                eventInputs.forEach(input => input.disabled = false);
            }
        }

        typeSelect.addEventListener('change', toggleFields);
        toggleFields(); // –í—ã–∑—ã–≤–∞–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã, —á—Ç–æ–±—ã —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    });
</script>
{% endblock %}